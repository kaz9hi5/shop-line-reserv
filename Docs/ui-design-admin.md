# UI/UX 設計書（管理画面）

## 1. 画面一覧

### 1.1 ショップスタッフ向け画面（管理画面）

#### 1.1.1 管理画面の全体構成

**レイアウト構造**

```
┌ ヘッダー
│  店名
├ ナビゲーション
│  ・本日の予約一覧と予約受付
│  ・営業時間と日別営業時間の設定
│  ・施術メニュー編集
│  ・メンバー編集
│  ・IP アドレス管理
└ メイン
   ・当月カレンダー＋日別予約状況一覧（中心）
```

**設計方針**

- 画面は 2〜3 枚までがベスト
- 店員は「今日の予約」が最優先

#### 1.1.2 メイン画面：当月カレンダー＋日別予約状況一覧（最重要）

**カレンダー表示設定**

- 週の始まりは月曜日
- 営業時間・営業日の設定に基づいて予約可能な時間帯を表示

**画面イメージ**

```
左：当月カレンダー（週の始まり：月）
右：日別予約状況一覧（選択日：2025年3月20日）

10:00 |  予約あり（山田様 / ジェル / 60分） [来店]
11:00 |  空き
12:00 |  空き
13:00 |  予約あり（電話予約 / 90分） [来店]
14:00 |  予約あり（佐藤様 / フット / 60分） [来店]
15:00 |  空き
```

**特徴**

- 左：当月カレンダーで日付を直感的に選択できる
- 右：選択日の予約状況を時間帯ごとに一覧できる
- 同時予約最大 5 件 → 横並び不要、1 枠 1 予約で OK
- 予約ありの日付には印（ドット）を表示

**予約可能時間の算出方法（管理画面）**

- 管理画面からの予約作成では、営業日・営業時間の制限は適用しない
- 朝 7 時から 23 時 59 分までの任意の時間に予約可能
- 既存予約と重複しない時間帯のみ予約可能として表示
- 営業時間や昼休憩時間の制限は適用しない（お客様画面とは異なる）
- 予約時刻＋施術時間で次の予約可能時間を算出
- 例：10:00 に 60 分の施術が予約されている場合、次の予約可能時間は 11:00 から
- 例：13:00 に 90 分の施術が予約されている場合、次の予約可能時間は 14:30 から

**操作**

| 操作                         | 動作                           |
| ---------------------------- | ------------------------------ |
| 当月カレンダーの日付クリック | その日の日別予約状況一覧を表示 |
| 空き枠クリック               | 予約作成                       |
| 予約クリック                 | 詳細モーダル表示               |
| 来店ボタン                   | 来店確認（回数リセット）       |

#### 1.1.3 予約詳細モーダル（超重要）

**設計方針**

- 画面遷移させない
- 予約クリック → モーダル表示

**表示内容**

- お名前（LINE 表示名）
- LINE ユーザー ID（必要に応じて表示）
- **施術内容**
  - 施術内容の概要（フォーマット済み）
  - 施術時間
  - 価格（円）
- 日時
- ステータス

**操作ボタン**

- ✏️ 変更
- ❌ キャンセル
- 📩 LINE メッセージ再送

**変更操作**

- 日時変更
- 施術内容（メニュー）変更
  - 登録済みの施術内容から選択
- **予約変更の処理フロー**
  - 日時の変更でも施術内容の変更でも同じ処理フロー
    1. フロントエンドから Supabase DB に直接 CRUD 操作を実行
    2. 既存の予約情報を論理削除（変更のための内部処理。**予約キャンセル回数にはカウントしない**）
    3. 同じ LINE ユーザー ID であることを論理削除した予約情報と突合して確認
    4. 新たに予約情報を作成
    5. DB 保存後に Edge Function が自動的にトリガーされ、LINE メッセージ送信（予約変更完了通知）

**キャンセル操作**

- **UI 動作**
  - 「キャンセル」クリック → キャンセル実行
- **予約キャンセルの処理フロー**
  1. フロントエンドから Supabase DB に直接 CRUD 操作を実行
  2. 予約情報を論理削除
  3. DB 保存後に Edge Function が自動的にトリガーされ、キャンセル完了の LINE メッセージ通知を送信

**LINE メッセージ通知内容**

- **変更時**

```
【◯◯ネイルサロン】
ご予約内容が変更されました
3/20 15:00〜
```

- **キャンセル時**

```
【◯◯ネイルサロン】
ご予約がキャンセルされました
```

#### 1.1.4 予約作成画面（電話予約対応）

**起動方法**

- 空き枠クリック
- 「＋予約追加」ボタン

**入力項目**

- 名前
- LINE ユーザー ID（手動入力または検索）
- **施術内容（メニュー）**
  - 登録済みの施術内容から選択
  - 施術内容の概要と施術時間を表示
  - 価格（円）を表示
- 日時

**注意事項**

- LINE Login は不要（店員が代行作成）
- フロントエンドから Supabase DB に直接 CRUD 操作を実行して予約情報を作成
- DB 保存後に Edge Function が自動的にトリガーされ、「予約確定 LINE メッセージ」を送信

#### 1.1.5 予約一覧画面（補助画面）

**用途**

- 検索（名前 / LINE 表示名）
- 今日〜数日分を一覧確認

**表示例**

| 時間  | 名前 | LINE 表示名 | 施術内容 | 施術時間 | アクション | 来店 |
| ----- | ---- | ----------- | -------- | -------- | ---------- | ---- |
| 10:00 | 山田 | 山田 花子   | ジェル   | 60 分    | 詳細       | 来店 |

#### 1.1.5.1 来店確認（回数リセット）

- **目的**: スタッフが来店を確認したタイミングで、当該顧客（LINE ユーザー ID）単位の「予約キャンセル回数・予約変更回数」をリセットする
- **UI**
  - 日別予約状況一覧（当日一覧）および予約一覧（補助画面）の各予約に「来店」ボタンを表示
  - 押下後は「来店済」表示に切り替え（連打防止のためボタン無効化）
- **処理**
  - 「来店」押下 → LINE ユーザー ID 単位の回数を 0 にリセット
  - 必要に応じて、予約を「来店済」として記録（例：`arrived_at` を保存）

#### 1.1.6 設定画面（最低限）

**初期設定項目**

- **営業時間設定**（店長のみ：デフォルト営業時間、店長・店員：日毎の営業時間）

  - **デフォルト営業時間**（店長のみ）
    - 開始時間の選択（時・分）
    - 終了時間の選択（時・分）
    - **昼休憩時間の設定**（任意）
      - 昼休憩開始時間の選択（時・分）
      - 昼休憩終了時間の選択（時・分）
      - チェックボックスで有効/無効を切り替え可能
      - 昼休憩時間中は予約不可として扱う
    - 基本的な営業時間として使用
    - すべての日付のデフォルト値として適用される
  - **日毎の営業時間設定**（店長・店員）
    - デフォルト営業時間を主として使用
    - 日毎（具体的な日付）に営業時間を個別に設定可能
    - **表示期間**: 今日を含む 1 日から 1 ヶ月間
    - 月末を越えたら翌月を設定可能
    - 各日付に対して個別営業時間を設定するかどうかを選択可能
    - **表示条件**: 営業日に設定された日付のみ、個別営業時間の設定欄を表示
    - 未設定または営業日以外（休日・定休日）を選択した場合、個別チェックボックスやデフォルト営業時間を表示しない
    - 個別設定を有効にした場合、その日の開始時間・終了時間を設定可能（時・分）
    - 個別設定を有効にした場合、その日の昼休憩時間の設定欄を表示（デフォルトの昼休憩時間を継承するか、個別に設定可能）
    - 個別設定を無効にした場合、デフォルト営業時間が適用される
    - 日毎の設定がある場合は、その日の営業時間として優先される
    - 営業時間外の予約を制限
    - **UI 要素**
      - **1 ヶ月カレンダー表示**（今月 1 日〜今日を含む 1 ヶ月、月末を越えたら翌月へ）
      - 日付セルをクリックして対象日を選択
      - 営業日に設定された日付のみ、「個別営業時間を設定する」チェックボックスを表示
      - チェック ON 時：
        - 開始時間・終了時間の入力欄を表示
        - 昼休憩時間の設定欄を表示（デフォルトの昼休憩時間を継承するか、個別に設定可能）
      - チェック OFF 時：デフォルト営業時間を表示（編集不可）
      - 未設定または営業日以外の場合は個別営業時間設定欄を表示しない
    - **昼休憩時間の扱い**
      - 昼休憩時間中は予約不可として扱う
      - 予約可能時間の算出時に、昼休憩時間を除外する
    - **店員の権限**: 店員は自分の営業日・営業時間のみ設定可能（店員 ID で紐付け）

- **営業日設定**（店長・店員）

  - 日毎（具体的な日付）に営業日/休日/定休日を選択可能
  - **表示期間**: 今月 1 日から今日を含む 1 ヶ月間
  - 月末を越えたら翌月を設定可能
  - **色分け表示**: 営業日設定がされているかどうかを色分けして見分けられるようにする
  - **UI 表示**: 一週間のリスト表示ではなく、**1 ヶ月カレンダー表示**にする
    - 日付セルの色で状態を表現（例：営業日=青/緑、休日/定休日=グレー、未設定=無地）
    - 日付セルクリックでその日の設定（営業日/休日/定休日）を編集
  - 各日付に対して営業日/休日/定休日のいずれかを選択
  - **予約画面での表示ルール**
    - 各日付に対して営業日/休日/定休日のいずれかに設定した日付のみ予約画面に表示
    - 営業日に設定した日付のみ予約可能
    - 休日・定休日に設定した日付は予約不可として表示（グレーアウト）
    - 未設定の日付は予約画面に表示しない
  - **店員の権限**: 店員は自分の営業日のみ設定可能（店員 ID で紐付け）

- **カレンダー表示設定**
  - 週の始まりを月曜日に設定（管理画面・お客様画面共通）
- **予約制限設定**
  - 予約キャンセル・変更可能期限の設定
    - 予約キャンセルと予約変更の期限を同じ設定で管理
    - 設定範囲：1 時間前から 48 時間前まで選択可能
    - 予約日時から期限日時を引いて計算し、予約画面の表示に利用
- **施術内容管理**（詳細は 1.1.7 を参照）

**今後の拡張（後回し）**

- 価格管理
- スタッフ管理

#### 1.1.7 施術内容管理画面

**目的**: 施術内容の登録・変更・削除を行う

**起動方法**

- 設定画面から「施術内容管理」を選択

**主要要素**

- **施術内容一覧**
  - 登録済みの施術内容一覧を表示
  - 各項目：施術内容名、概要（フォーマット済み）、施術時間、価格（円）
  - 「編集」ボタン、「削除」ボタン
- **新規登録ボタン**
  - クリックで施術内容登録フォームを表示

**施術内容登録・編集フォーム**

- **入力項目**
  - 施術内容名（必須）
  - 施術内容の概要（必須）
    - テキストエリアで入力
    - 入力された内容は自動的にフォーマットされた形で保存
    - プレビュー機能（任意）
  - 施術時間（必須）
    - 分単位で入力（例：60 分、90 分）
  - 価格（必須）
    - 円単位で入力
- **操作ボタン**
  - 「保存」ボタン
  - 「キャンセル」ボタン

**フォーマット機能**

- 入力された施術内容の概要は以下の形式でフォーマット：
  - 改行の統一
  - 段落の整形
  - リスト形式の整形（必要に応じて）
- フォーマット後の内容をプレビュー表示（任意）

#### 1.1.8 IP アドレス管理画面（店長のみ）

**目的**: 管理画面へのアクセス許可 IP アドレスを管理（ホワイトリスト）

**主要要素**

- **許可 IP アドレス管理**
  - 許可 IP アドレスリストの表示
  - IP アドレスの削除（拒否）
  - 追加は 403（アクセス拒否）画面の「この IP を許可リストに追加」から行う
  - 現在の IP アドレスの自動検出と表示
  - 現在の IP アドレスが許可リストに登録されているかの確認表示
    - **店長・店員のロール設定**
      - 403 画面から追加された IP は、店長名照合に成功した場合でも **`admin_allowed_ips.staff_id` は `null` のまま登録**する（紐づけ編集は IP 管理ページで行う）
      - ロール（店長/店員）と staff との紐付けは IP 管理画面で編集できる
      - ロールは`staff_id`が紐づいている場合は`staff.role`から取得（`manager`または`staff`）
      - 店員は `reservations`、`business_days`、`business_hours_overrides` テーブルのみアクセス可能
      - 店長はすべてのテーブルにアクセス可能
    - **アクセス許可画面からの遷移制御**
      - アクセス許可画面（IP 管理画面）にいる時は、以下のリンクを無効化して画面遷移をブロック：
        - 「本日の予約一覧と予約受付」（`/admin`）
        - 「営業時間と日別営業時間の設定」（`/admin/settings`）
        - 「施術メニュー編集」（`/admin/treatments`）
        - 「メンバー編集」（`/admin/members`）
      - IP 管理画面にいる時は常にこれらのリンクが無効化され、警告メッセージを表示
      - 警告メッセージ：「IP 管理画面では、他の画面に遷移できません。IP 管理を完了してから他の画面にアクセスしてください。」
      - IP 管理を完了してから他の画面にアクセスする必要がある
  - **403 画面からの追加の認証**
    - 「この IP を許可リストに追加」実行前に **店長名** の入力を求める
    - 入力値が `staff` テーブルの `role=manager` の `name` と一致した場合のみ追加できる（不一致は追加不可）
  - **端末情報の自動登録**
    - IP アドレス追加時にデバイスフィンガープリントを自動生成・保存
    - User-Agent、言語、プラットフォームなどのブラウザ情報から生成
  - **IP アドレスリストの扱い**
    - リストに追加した IP アドレスは「許可」として扱う
    - リストから削除した IP アドレスは「拒否」として扱う
    - ホワイトリスト方式（リストに存在する IP のみ許可、それ以外は拒否）
  - **実装詳細**
    - IP 追加・削除時に Edge Function `admin-db-proxy` 経由で DB に CRUD 操作を実行
    - コンテキストの状態も自動更新され、即座にアクセス制御が反映される
    - IP 追加後は自動的に許可状態が再チェックされ、予約一覧画面にアクセス可能になる
      - すべてのデータベース操作は Edge Function 経由で実行され、端末情報に基づく権限チェックが行われる

**注意**: `admin_allowed_ips`テーブルに登録されている IP アドレスのみ管理画面にアクセス可能

#### 1.1.9 メンバー編集画面（店長のみ）

**目的**: `staff`テーブルのメンバー（店員）の名前編集・削除を行う

**起動方法**

- メニュータブから「メンバー編集」を選択

**主要要素**

- **メンバー一覧**
  - 表示項目: 名前、ロール（店長/店員）
  - 各行に「編集」「削除」ボタン
- **新規追加**
  - 店員の追加（名前入力、ロールは基本 `staff`。必要なら店長が変更できる）

**制約・ルール**

- 店長（`role=manager`）は削除できない（削除ボタン非表示/無効）
- **削除方式**: `staff`テーブルは論理削除（メンバー編集の削除＝`deleted_at`相当のフラグを立てる）
- **店員削除時の関連データの扱い**:
  - `business_days` / `business_hours_overrides` の 2 テーブルにある、削除対象店員（`staff_id`一致）のレコードは **物理削除**

## 2. 画面遷移図

### 2.1 スタッフ向けフロー

```
メイン画面（当月カレンダー＋日別予約状況一覧）
  ├→ 空き枠クリック → 予約作成画面 → メイン画面
  ├→ 予約クリック → 予約詳細モーダル
  │   ├→ 変更 → メイン画面（自動SMS送信）
  │   └→ キャンセル → メイン画面（自動SMS送信）
  ├→ 予約一覧（補助画面）
  └→ 設定画面
      ├→ 施術内容管理 → 施術内容管理画面
      │   ├→ 新規登録 → 施術内容登録フォーム → 施術内容管理画面
      │   └→ 編集 → 施術内容編集フォーム → 施術内容管理画面
      ├→ メンバー編集画面（店長のみ）
      │   └→ メンバー一覧（編集/削除/追加）
      └→ IP アドレス管理画面（店長のみ）
          └→ 許可 IP アドレス管理
```

**モーダル設計**

- 予約詳細は画面遷移せず、モーダルで表示
- 変更操作はモーダル内で完結
- キャンセル操作もモーダル内で完結
- 変更・キャンセル実行後は自動的に LINE メッセージ通知が送信される

## 3. UI/UX 要件

### 3.1 デザイン原則

- **シンプルで直感的な操作**: 予約フローを明確に
- **アクセシビリティ**: 誰でも使いやすい UI

### 3.2 レスポンシブデザイン

- **管理画面**: PC、タブレット（電話対応しながら操作可能）

### 3.3 エラーハンドリング

- 入力エラーの明確な表示
- 予約不可日時の明確な表示

### 3.4 ローディング状態

- API 通信中のローディング表示

### 3.5 管理画面 UX 上の重要ポイント（現場目線）

**👍 良い設計**

- 今日の予約が即見える
- 電話対応しながらでも操作可能
- 変更したら自動で SMS が飛ぶ
- 画面遷移を最小限に（モーダル活用）
- 店員は考えさせないのが正解

**❌ 悪い設計**

- 一覧画面が先に出る
- 予約詳細で画面遷移
- 変更後に「SMS 送りますか？」確認

### 3.6 権限・アクセス制御設計

**店員管理**

- **店員テーブル**

  - 店員 ID（主キー）、名前、ロール（店長/店員）を保存
  - 店長と店員 n の複数の名前が登録可能
  - 店長が店員の登録・管理を行う

- **IP アドレス制限**

  - 管理画面へのアクセスを特定の IP アドレスからのみ許可
  - **IP アドレスリストの扱い**
    - アクセスリストに追加した IP アドレスは「許可」として扱う
    - リストから削除した IP アドレスは「拒否」として扱う
    - ホワイトリスト方式（リストに存在する IP のみ許可、それ以外は拒否）
  - 許可されていない IP アドレスからのアクセスは 403 エラーを表示
  - 許可 IP アドレスリストはアクセスログ画面（IP 管理ページ）で管理可能（店長のみ）
  - **店員と IP アドレスの紐付け**
    - `admin_allowed_ips.staff_id` でスタッフテーブルと紐付け可能（オプショナル）
    - ロールは`staff_id`が紐づいている場合は`staff.role`から取得（`manager`または`staff`）
    - `staff_id`が未紐付けの場合はロールが取得できず、アクセス許可画面から他の画面への遷移がブロックされる
  - **実装詳細**
    - IP アドレスの検出は外部 API（ipify.org）を使用
    - `AdminAccessContext` で IP アドレスの検出と許可状態を管理
    - `AdminAccessGate` でアクセス制御を実装
    - IP 追加・削除時にコンテキストの状態が自動更新され、即座に反映される
    - IP は **10 秒おきに自動再取得**し、許可判定を更新する（403 画面に「IP を再取得」ボタンは置かない）
    - **Edge Function 経由のデータベース操作**: すべてのデータベース操作は `admin-db-proxy` Edge Function 経由で実行
    - **端末情報による識別**: User-Agent などのブラウザ情報からデバイスフィンガープリントを生成し、端末を識別
    - **ロールベースアクセス制御**: 店長・店員のロールに基づいてアクセス権限を制御
      - **店員の権限**:
        - 操作できる DB テーブル: `reservations`、`business_days`、`business_hours_overrides`
        - 触れる画面: 営業日・営業時間設定欄のみ（予約管理機能も含む）
        - 自分の営業日・営業時間のみ設定可能（店員 ID で紐付け）
      - **店長の権限**:
        - すべての DB テーブルにアクセス可能
        - すべての管理機能にアクセス可能

**IP アドレス制限（ホワイトリスト）**

- `admin_allowed_ips`テーブルに登録されている IP アドレスのみ管理画面にアクセス可能
- IP アドレスリストは店長が管理（店長のみアクセス可能）
- ホワイトリスト方式（リストに存在する IP のみ許可、それ以外は拒否）

## 4. 今後の検討事項

- 具体的なデザインカラー・フォント選定
- アイコン・画像の選定
- アニメーション・トランジション効果
- 設定画面の拡張（価格管理・スタッフ管理）

---

**作成日**: 2024 年
**バージョン**: 1.0
