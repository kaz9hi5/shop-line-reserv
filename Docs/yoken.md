# ネイルショップ予約システム 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名

ネイルショップ予約システム

### 1.2 プロジェクトの目的

ネイルショップ向けのウェブサイトを構築し、SMS 認証を利用した予約システムを実現する。

### 1.3 対象ユーザー

- **顧客**: ネイルショップを利用する顧客
- **ショップスタッフ**: ネイルショップのスタッフ

## 2. 機能要件

### 2.1 顧客向け機能

#### 2.1.1 予約フロー

**① お客さん予約**

1. 日時・メニュー選択
   - 施術内容の概要、施術時間、価格を表示
   - メニューを選択
2. 名前・電話番号入力
3. 「SMS 認証コード送信」ボタンをクリック
4. 6 桁コード入力
5. 予約確定（フロントエンドから Supabase DB に直接 CRUD 操作を実行）
6. DB 保存後に Edge Function が自動的にトリガーされ、予約確認 SMS 送信（予約変更・キャンセル URL 付き）
7. ⏱ 1 分以内で完了

**予約キャンセル・予約変更**

- SMS 通知内の予約変更・キャンセル URL から予約をキャンセル・変更可能
- 予約キャンセル・変更可能期限：1 時間前から 48 時間前まで選択可能（設定画面で管理可能）
- **予約キャンセル**
  - 期限内の場合は通常のキャンセルが可能
  - 期限を過ぎた場合でも「店に行けない」ボタンからキャンセル可能
  - 予約変更ページへ遷移するリンクあり
  - **予約キャンセルの処理フロー**（期限内・期限超過どちらも同じ）
    1. フロントエンドから Supabase DB に直接 CRUD 操作を実行
    2. 予約情報を論理削除
    3. DB 保存後に Edge Function が自動的にトリガーされ、キャンセル完了の SMS 通知を送信
- **予約変更**
  - 期限内の場合は予約変更が可能
  - 日時の変更と施術メニューの変更が可能（どちらも同じ処理フロー）
  - 現在選択中の日時・施術内容と予約済みの日時・施術内容は選択不可
  - **予約変更の処理フロー**
    1. フロントエンドから Supabase DB に直接 CRUD 操作を実行
    2. 既存の予約情報を論理削除
    3. 同じ SMS（電話番号）であることを論理削除した予約情報と突合して確認
    4. 新たに予約情報を作成
    5. DB 保存後に Edge Function が自動的にトリガーされ、予約変更完了の SMS 通知を送信

#### 2.1.2 予約管理機能

- 予約可能な日時の確認
  - **予約可能時間の算出方法**
    - 予約時刻＋施術時間で次の予約可能時間を算出
    - 例：10:00 に 60 分の施術が予約されている場合、次の予約可能時間は 11:00 から
    - 例：13:00 に 90 分の施術が予約されている場合、次の予約可能時間は 14:30 から
    - 営業時間内で、既存予約と重複しない時間帯のみ予約可能として表示
    - 昼休憩時間中は予約不可として扱う（昼休憩時間を除外）
    - 管理画面・お客様画面ともに同じ算出方法を使用
- 予約内容の確認
- 予約のキャンセル・変更（SMS 通知内の予約変更・キャンセル URL から実行可能）
  - 予約キャンセル・変更可能期限：1 時間前から 48 時間前まで選択可能（設定画面で管理可能）
  - **予約キャンセル**
    - 期限内の場合は通常のキャンセルが可能
    - 期限を過ぎた場合でも「店に行けない」ボタンからキャンセル可能（処理フローは同じ）
    - 予約変更ページへ遷移するリンクあり
    - **予約キャンセルの処理フロー**（期限内・期限超過どちらも同じ）
      1. フロントエンドから Supabase DB に直接 CRUD 操作を実行
      2. 予約情報を論理削除
      3. DB 保存後に Edge Function が自動的にトリガーされ、キャンセル完了の SMS 通知を送信
  - **予約変更**
    - 期限内の場合は予約変更が可能
    - 期限を過ぎた場合は変更不可
    - 予約キャンセルページから予約変更ページへ遷移可能
    - 日時の変更と施術メニューの変更が可能（どちらも同じ処理フロー）
    - 変更時は、現在選択中の日時・施術内容と予約済みの日時・施術内容は選択不可
    - **予約変更の処理フロー**
      1. フロントエンドから Supabase DB に直接 CRUD 操作を実行
      2. 既存の予約情報を論理削除
      3. 同じ SMS（電話番号）であることを論理削除した予約情報と突合して確認
      4. 新たに予約情報を作成
      5. DB 保存後に Edge Function が自動的にトリガーされ、予約変更完了の SMS 通知を送信

#### 2.1.3 通知機能

- 予約登録完了後（DB 保存後）、Edge Function が自動的にトリガーされ、予約完了を SMS で顧客にのみ通知
- SMS 通知内に予約取り消しリンクを含める

### 2.2 ショップスタッフ向け機能（管理画面）

#### 2.2.1 予約管理機能

**② 店員（管理画面）**

**予約作成**

- カレンダー表示
- 空き枠クリック → 予約作成
- 電話予約もそのまま登録可能
- **予約可能時間の算出方法**
  - 予約時刻＋施術時間で次の予約可能時間を算出
  - 例：10:00 に 60 分の施術が予約されている場合、次の予約可能時間は 11:00 から
  - 例：13:00 に 90 分の施術が予約されている場合、次の予約可能時間は 14:30 から
  - 営業時間内で、既存予約と重複しない時間帯のみ予約可能として表示
  - 昼休憩時間中は予約不可として扱う（昼休憩時間を除外）
  - お客様画面と同じ算出方法を使用
- フロントエンドから Supabase DB に直接 CRUD 操作を実行して予約情報を作成
- DB 保存後に Edge Function が自動的にトリガーされ、予約確定 SMS を送信

**予約変更**

- フロントエンドから Supabase DB に直接 CRUD 操作を実行
- 既存の予約情報を論理削除
- 同じ SMS（電話番号）であることを論理削除した予約情報と突合して確認
- 新たに予約情報を作成
- DB 保存後に Edge Function が自動的にトリガーされ、お客さんに SMS 通知

**予約キャンセル**

- フロントエンドから Supabase DB に直接 CRUD 操作を実行
- 予約情報を論理削除
- DB 保存後に Edge Function が自動的にトリガーされ、キャンセル完了の SMS 通知を送信

#### 2.2.2 施術内容管理機能

- **施術内容の登録・変更**
  - 施術内容の概要を登録・変更
  - 施術時間を登録・変更
  - 価格を登録・変更（単位：円）
  - 入力された施術内容の概要はフォーマットされた形で保存
  - 設定画面から管理可能

#### 2.2.3 営業時間・営業日管理機能

- **営業時間の設定**

  - **デフォルト営業時間の設定**
    - 開始時間と終了時間を設定可能
    - 昼休憩時間の設定（開始時間・終了時間）を設定可能（任意）
    - 設定画面から管理可能
    - 基本的な営業時間として使用
  - **日毎の営業時間の設定**
    - デフォルト営業時間を主として使用
    - 日毎（具体的な日付）に営業時間を個別に設定可能
    - 月曜日から日曜日までの一週間分の日付を対象
    - 各日付に対して個別営業時間を設定するかどうかを選択可能
    - 個別設定を有効にした場合、その日の開始時間・終了時間を設定可能
    - 個別設定を有効にした場合、その日の昼休憩時間（開始時間・終了時間）も設定可能（任意、デフォルトの昼休憩時間を継承することも可能）
    - 個別設定を無効にした場合、デフォルト営業時間が適用される
    - 日毎の設定がある場合は、その日の営業時間として優先される
    - 営業日が未設定（営業日/休日/定休日のいずれにも設定されていない）の場合は、営業時間の個別設定は表示されない
    - 設定画面から管理可能
    - 予約可能な時間帯の制御に使用
    - 昼休憩時間中は予約不可として扱う

- **営業日の設定**

  - 日毎（具体的な日付）に営業日/休日/定休日を設定可能
  - 設定画面から管理可能
  - **予約画面での表示ルール**
    - 月曜日から日曜日までの一週間分を対象
    - 各日付に対して営業日/休日/定休日のいずれかに設定した日付のみ予約画面に表示
    - 営業日に設定した日付のみ予約可能
    - 休日・定休日に設定した日付は予約不可として表示（グレーアウト）
    - 未設定の日付は予約画面に表示しない

- **カレンダー表示設定**
  - 管理画面・お客様画面ともに、カレンダーの週の始まりを月曜日に設定
  - 週の始まりを統一することで、操作性を向上

#### 2.2.4 予約制限管理機能

- **予約キャンセル・変更期限設定**
  - 予約キャンセルと予約変更の可能期限を同じ設定で管理
  - 設定範囲：1 時間前から 48 時間前まで選択可能
  - 設定画面から管理可能
  - 予約日時から期限日時を引いて計算し、予約画面の表示に利用

#### 2.2.5 その他

- 予約一覧の確認
- **アクセスログ制御機能**
  - アクセスログの記録を ON/OFF する機能
  - 設定画面から制御可能

## 3. システム構成

### 3.1 アーキテクチャ

詳細は [tech-stack.md](./tech-stack.md) を参照してください。

### 3.2 技術スタック

詳細は [tech-stack.md](./tech-stack.md) を参照してください。

### 3.3 UI/UX 設計

- 顧客向け画面: 詳細は [ui-design-customer.md](./ui-design-customer.md) を参照してください。
- 管理画面: 詳細は [ui-design-admin.md](./ui-design-admin.md) を参照してください。

## 4. 非機能要件

### 4.1 セキュリティ

- SMS 認証による本人確認の実現
- 個人情報の適切な管理
- **管理画面の IP アドレス制限**
  - 管理画面へのアクセスを特定の IP アドレスからのみ許可
  - **IP アドレスリストの扱い**
    - アクセスリストに追加した IP アドレスは「許可」として扱う
    - リストから削除した IP アドレスは「拒否」として扱う
    - ホワイトリスト方式（リストに存在する IP のみ許可、それ以外は拒否）
  - Supabase RLS（Row Level Security）またはフロントエンド側で IP アドレスチェック機能を実装
  - 許可 IP アドレスリストの管理機能
- **アクセスログ機能**
  - 管理画面へのアクセス試行を DB に記録（日時、IP アドレス、アクセス結果）
  - IP アドレス選定のためのアクセス履歴確認に利用
  - アクセスログの記録を ON/OFF する機能を管理画面に実装

### 4.2 可用性

- 予約システムの安定稼働

## 5. 今後の検討事項

- フロントエンドの技術スタック選定
- データベース設計（Supabase）
- API 設計
- UI/UX 設計（詳細は [ui-design-customer.md](./ui-design-customer.md) と [ui-design-admin.md](./ui-design-admin.md) を参照）

---

**作成日**: 2024 年
**バージョン**: 1.0
