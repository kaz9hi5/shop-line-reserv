# ネイルショップ予約システム 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名

ネイルショップ予約システム

### 1.2 プロジェクトの目的

ネイルショップ向けのウェブサイトを構築し、LINE お友達登録を利用した予約システムを実現する。予約は LINE アプリからのみ受け付ける。

### 1.3 対象ユーザー

- **顧客**: ネイルショップを利用する顧客
- **ショップスタッフ**: ネイルショップのスタッフ
  - **店長**: すべての管理機能にアクセス可能
  - **店員**: 予約管理と自分の営業日・営業時間設定のみアクセス可能

## 2. 機能要件

### 2.1 顧客向け機能

#### 2.1.1 予約フロー

**① お客さん予約**

1. LINE アプリから Web アプリへ遷移（LINE お友達登録済みユーザー）
2. 日時・メニュー選択
   - 施術内容の概要、施術時間、価格を表示
   - メニューを選択
3. 名前確認・入力（LINE 表示名から取得、必要に応じて編集）
4. 予約確定（フロントエンドから Supabase DB に直接 CRUD 操作を実行）
5. DB 保存後に Edge Function が自動的にトリガーされ、予約確認 LINE メッセージ送信（予約変更・キャンセル操作ボタン付き）
6. ⏱ 1 分以内で完了

**LINE お友達登録処理**

- LINE 公式アカウントにお友達登録した時点で、LINE Webhook を通じてユーザー情報を取得
- `line_users`テーブルに LINE ユーザー ID、LINE 表示名、プロフィール画像 URL などを自動保存
- お友達解除時は`is_friend`フラグを`false`に更新

**予約キャンセル・予約変更**

- LINE メッセージ内の予約変更・キャンセルボタンから予約をキャンセル・変更可能
- LINE アプリ内で完結する操作、または LINE メッセージ内の URL から Web アプリへ遷移して操作可能
- 予約キャンセル・変更可能期限：1 時間前から 48 時間前まで選択可能（設定画面で管理可能）
- **予約キャンセル回数 / 予約変更回数（LINE ユーザー ID 単位）**
  - キャンセル回数・変更回数を **LINE ユーザー ID 単位**で記録する
  - スタッフが来店を確認して管理画面の「来店」ボタンを押したタイミングで **回数をリセット（0）**
  - ※回数上限による予約不可などの制御は行わない（現時点は記録・リセットのみ）
- **予約キャンセル**
  - 期限内の場合は通常のキャンセルが可能
  - 期限を過ぎた場合でも「店に行けない」ボタンからキャンセル可能
  - 予約変更ページへ遷移するリンクあり
  - **予約キャンセルの処理フロー**（期限内・期限超過どちらも同じ）
    1. LINE メッセージのボタン操作、または Web アプリから Supabase DB に直接 CRUD 操作を実行
    2. 予約情報を論理削除
    3. DB 保存後に Edge Function が自動的にトリガーされ、キャンセル完了の LINE メッセージ通知を送信
  - 予約キャンセル実行時に、予約キャンセル回数を **+1**（LINE ユーザー ID 単位）
- **予約変更**
  - 期限内の場合は予約変更が可能
  - 日時の変更と施術メニューの変更が可能（どちらも同じ処理フロー）
  - 現在選択中の日時・施術内容と予約済みの日時・施術内容は選択不可
  - **予約変更の処理フロー**
    1. LINE メッセージのボタン操作、または Web アプリから Supabase DB に直接 CRUD 操作を実行
    2. 既存の予約情報を論理削除（変更のための内部処理。**予約キャンセル回数にはカウントしない**）
    3. 同じ LINE ユーザー ID であることを論理削除した予約情報と突合して確認
    4. 新たに予約情報を作成
    5. DB 保存後に Edge Function が自動的にトリガーされ、予約変更完了の LINE メッセージ通知を送信
  - 予約変更実行時に、予約変更回数を **+1**（LINE ユーザー ID 単位）

#### 2.1.2 予約管理機能

- 予約可能な日時の確認
  - **予約可能時間の算出方法**
    - 予約時刻＋施術時間で次の予約可能時間を算出
    - 例：10:00 に 60 分の施術が予約されている場合、次の予約可能時間は 11:00 から
    - 例：13:00 に 90 分の施術が予約されている場合、次の予約可能時間は 14:30 から
    - 営業時間内で、既存予約と重複しない時間帯のみ予約可能として表示
    - 昼休憩時間中は予約不可として扱う（昼休憩時間を除外）
    - 管理画面・お客様画面ともに同じ算出方法を使用
- 予約内容の確認
- 予約のキャンセル・変更（LINE メッセージ内の予約変更・キャンセルボタンから実行可能）
  - 予約キャンセル・変更可能期限：1 時間前から 48 時間前まで選択可能（設定画面で管理可能）
  - **予約キャンセル回数 / 予約変更回数（LINE ユーザー ID 単位）**
    - キャンセル回数・変更回数を LINE ユーザー ID 単位で記録する
    - 来店後にスタッフが管理画面の「来店」ボタンで回数をリセット（0）
  - **予約キャンセル**
    - 期限内の場合は通常のキャンセルが可能
    - 期限を過ぎた場合でも「店に行けない」ボタンからキャンセル可能（処理フローは同じ）
    - 予約変更ページへ遷移するリンクあり
    - **予約キャンセルの処理フロー**（期限内・期限超過どちらも同じ）
      1. LINE メッセージのボタン操作、または Web アプリから Supabase DB に直接 CRUD 操作を実行
      2. 予約情報を論理削除
      3. DB 保存後に Edge Function が自動的にトリガーされ、キャンセル完了の LINE メッセージ通知を送信
    - 予約キャンセル実行時に、予約キャンセル回数を **+1**（LINE ユーザー ID 単位）
  - **予約変更**
    - 期限内の場合は予約変更が可能
    - 期限を過ぎた場合は変更不可
    - 予約キャンセルページから予約変更ページへ遷移可能
    - 日時の変更と施術メニューの変更が可能（どちらも同じ処理フロー）
    - 変更時は、現在選択中の日時・施術内容と予約済みの日時・施術内容は選択不可
    - **予約変更の処理フロー**
      1. LINE メッセージのボタン操作、または Web アプリから Supabase DB に直接 CRUD 操作を実行
      2. 既存の予約情報を論理削除（変更のための内部処理。**予約キャンセル回数にはカウントしない**）
      3. 同じ LINE ユーザー ID であることを論理削除した予約情報と突合して確認
      4. 新たに予約情報を作成
      5. DB 保存後に Edge Function が自動的にトリガーされ、予約変更完了の LINE メッセージ通知を送信
    - 予約変更実行時に、予約変更回数を **+1**（LINE ユーザー ID 単位）

#### 2.1.3 通知機能

- 予約登録完了後（DB 保存後）、Edge Function が自動的にトリガーされ、予約完了を LINE メッセージで顧客にのみ通知
- LINE メッセージ内に予約変更・キャンセル操作ボタンを含める

### 2.2 ショップスタッフ向け機能（管理画面）

#### 2.2.1 予約管理機能

**② 店員（管理画面）**

**予約作成**

- カレンダー表示
- 空き枠クリック → 予約作成
- 電話予約もそのまま登録可能（LINE ユーザー ID を手動入力または検索）
- **予約可能時間の算出方法**
  - 予約時刻＋施術時間で次の予約可能時間を算出
  - 例：10:00 に 60 分の施術が予約されている場合、次の予約可能時間は 11:00 から
  - 例：13:00 に 90 分の施術が予約されている場合、次の予約可能時間は 14:30 から
  - 営業時間内で、既存予約と重複しない時間帯のみ予約可能として表示
  - 昼休憩時間中は予約不可として扱う（昼休憩時間を除外）
  - お客様画面と同じ算出方法を使用
- フロントエンドから Supabase DB に直接 CRUD 操作を実行して予約情報を作成
- DB 保存後に Edge Function が自動的にトリガーされ、予約確定 LINE メッセージを送信

**予約変更**

- フロントエンドから Supabase DB に直接 CRUD 操作を実行
- 既存の予約情報を論理削除（変更のための内部処理。**予約キャンセル回数にはカウントしない**）
- 同じ LINE ユーザー ID であることを論理削除した予約情報と突合して確認
- 新たに予約情報を作成
- DB 保存後に Edge Function が自動的にトリガーされ、お客さんに LINE メッセージ通知

**予約キャンセル**

- フロントエンドから Supabase DB に直接 CRUD 操作を実行
- 予約情報を論理削除
- DB 保存後に Edge Function が自動的にトリガーされ、キャンセル完了の LINE メッセージ通知を送信
- 予約キャンセル実行時に、予約キャンセル回数を **+1**（LINE ユーザー ID 単位）

**来店確認（回数リセット）**

- 予約状況一覧（当日一覧）の各予約に「来店」ボタンを表示
- スタッフが来店を確認したら「来店」ボタンを押す
- 押下時に以下を実行：
  - LINE ユーザー ID に紐づく`customer_action_counters`レコードを物理削除
  - 必要に応じて、予約を「来店済」として記録（例：arrived_at を保存）

#### 2.2.2 施術内容管理機能

- **施術内容の登録・変更**
  - 施術内容の概要を登録・変更
  - 施術時間を登録・変更
  - 価格を登録・変更（単位：円）
  - 入力された施術内容の概要はフォーマットされた形で保存
  - 設定画面から管理可能

#### 2.2.3 営業時間・営業日管理機能

- **営業時間の設定**

  - **デフォルト営業時間の設定**（店長のみ）
    - 開始時間と終了時間を設定可能
    - 昼休憩時間の設定（開始時間・終了時間）を設定可能（任意）
    - 設定画面から管理可能
    - 基本的な営業時間として使用
  - **日毎の営業時間の設定**（店長・店員）
    - デフォルト営業時間を主として使用
    - 日毎（具体的な日付）に営業時間を個別に設定可能
    - **表示期間**: 今月 1 日から今日を含む 1 ヶ月間
    - 月末を越えたら翌月を設定可能
    - 各日付に対して個別営業時間を設定するかどうかを選択可能
    - **表示条件**: 営業日に設定された日付のみ、個別営業時間の設定欄を表示
    - 未設定または営業日以外（休日・定休日）を選択した場合、個別チェックボックスやデフォルト営業時間を表示しない
    - 個別設定を有効にした場合、その日の開始時間・終了時間を設定可能
    - 個別設定を有効にした場合、その日の昼休憩時間（開始時間・終了時間）も設定可能（任意、デフォルトの昼休憩時間を継承することも可能）
    - 個別設定を無効にした場合、デフォルト営業時間が適用される
    - 日毎の設定がある場合は、その日の営業時間として優先される
    - 設定画面から管理可能
    - 予約可能な時間帯の制御に使用
    - 昼休憩時間中は予約不可として扱う
    - **店員の権限**: 店員は自分の営業日・営業時間のみ設定可能（店員 ID で紐付け）

- **営業日の設定**（店長・店員）

  - 日毎（具体的な日付）に営業日/休日/定休日を設定可能
  - **表示期間**: 今月 1 日から今日を含む 1 ヶ月間
  - 月末を越えたら翌月を設定可能
  - **色分け表示**: 営業日設定がされているかどうかを色分けして見分けられるようにする
  - 設定画面から管理可能
  - **予約画面での表示ルール**
    - 各日付に対して営業日/休日/定休日のいずれかに設定した日付のみ予約画面に表示
    - 営業日に設定した日付のみ予約可能
    - 休日・定休日に設定した日付は予約不可として表示（グレーアウト）
    - 未設定の日付は予約画面に表示しない
  - **店員の権限**: 店員は自分の営業日のみ設定可能（店員 ID で紐付け）

- **カレンダー表示設定**
  - 管理画面・お客様画面ともに、カレンダーの週の始まりを月曜日に設定
  - 週の始まりを統一することで、操作性を向上

#### 2.2.4 予約制限管理機能

- **予約キャンセル・変更期限設定**
  - 予約キャンセルと予約変更の可能期限を同じ設定で管理
  - 設定範囲：1 時間前から 48 時間前まで選択可能
  - 設定画面から管理可能
  - 予約日時から期限日時を引いて計算し、予約画面の表示に利用

#### 2.2.5 店員管理機能（店長のみ）

- **目的**

  - 管理画面の「メンバー編集」から、`staff`テーブルのメンバー名（店員名）を編集・削除する

- **メンバー（店員）の登録・管理**

  - 店長が店員の名前を登録・管理
  - 店員テーブルに店員 ID、名前、ロール（店長/店員）を保存
  - **初期データ**: ロールが`manager`のレコードが登録済み、名前は「店長」
  - 店員 1 人に対して複数の IP アドレスを登録可能
  - IP アドレス登録時は店長が許可か拒否を選択するルール
  - **削除制約**
    - 店長（`role=manager`）は削除できない
    - **削除方式**: `staff`テーブルは論理削除で運用する（管理画面のメンバー編集で削除されたら論理削除）
    - **店員削除時の関連データの扱い**:
      - `business_days` / `business_hours_overrides` の 2 テーブルにある、削除対象店員（`staff_id`一致）のレコードは **物理削除**

- **店員と IP アドレスの紐付け**

  - （廃止）`admin_allowed_ips` に店員 ID を持たせる紐付けは行わない

- **店員の権限**
  - 店員が操作できる DB テーブル: `reservations`、`business_days`、`business_hours_overrides`
  - 店員が触れる画面: 営業日・営業時間設定欄のみ（予約管理機能も含む）
  - 店員は自分の営業日・営業時間のみ設定可能（店員 ID で紐付け）

#### 2.2.6 その他

- 予約一覧の確認
- **アクセスログ制御機能**
  - アクセスログの記録を ON/OFF する機能
  - 設定画面から制御可能

## 3. システム構成

### 3.1 アーキテクチャ

詳細は [tech-stack.md](./tech-stack.md) を参照してください。

### 3.2 技術スタック

詳細は [tech-stack.md](./tech-stack.md) を参照してください。

### 3.3 UI/UX 設計

- 顧客向け画面: 詳細は [ui-design-customer.md](./ui-design-customer.md) を参照してください。
- 管理画面: 詳細は [ui-design-admin.md](./ui-design-admin.md) を参照してください。

## 4. 非機能要件

### 4.1 セキュリティ

- LINE お友達登録によるユーザー識別の実現
- 個人情報の適切な管理
- LINE Webhook の署名検証による改ざん防止
- **管理画面の IP アドレス制限（ホワイトリスト）**
  - 管理画面へのアクセスを特定の IP アドレスからのみ許可
  - `admin_allowed_ips`テーブルに登録されている IP アドレスのみ管理画面にアクセス可能
  - **許可 IP の追加（403 画面）**
    - 403（アクセス拒否）画面の「この IP を許可リストに追加」から追加できる
    - 追加には **店長名の一致**が必要（`staff`テーブルの`role=manager`の`name` と一致した場合のみ追加可能）
    - IP の再取得は **10 秒おきに自動実行**される（403 画面に「IP を再取得」ボタンは置かない）
    - 403 画面から追加された IP は、店長名照合に成功した場合でも **`admin_allowed_ips.staff_id` は `null` のまま登録**する（紐づけ編集は IP 管理ページで行う）
  - **IP アドレスリストの扱い**
    - アクセスリストに追加した IP アドレスは「許可」として扱う
    - リストから削除した IP アドレスは「拒否」として扱う
  - **アクセス許可画面からの遷移制御**
    - アクセス許可画面（IP管理画面）にいる時は、以下のリンクを無効化して画面遷移をブロック：
      - 「本日の予約一覧と予約受付」（`/admin`）
      - 「営業時間と日別営業時間の設定」（`/admin/settings`）
      - 「施術メニュー編集」（`/admin/treatments`）
      - 「メンバー編集」（`/admin/members`）
    - IP管理画面にいる時は常にこれらのリンクが無効化され、警告メッセージを表示
    - IP管理を完了してから他の画面にアクセスする必要がある
    - ホワイトリスト方式（リストに存在する IP のみ許可、それ以外は拒否）
  - Supabase RLS（Row Level Security）またはフロントエンド側で IP アドレスチェック機能を実装
  - 許可 IP アドレスリストの管理機能（店長のみ）
    - 許可 IP には staff を紐付け可能（IP 管理画面で編集できる）

### 4.2 可用性

- 予約システムの安定稼働

## 5. 今後の検討事項

- フロントエンドの技術スタック選定
- データベース設計（Supabase）
- API 設計
- UI/UX 設計（詳細は [ui-design-customer.md](./ui-design-customer.md) と [ui-design-admin.md](./ui-design-admin.md) を参照）

---

**作成日**: 2024 年
**バージョン**: 1.0
